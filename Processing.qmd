---
title: "ProcessingScript"
format: html
---
```{r}
library(stringr)
```

```{r}
Folder <- file.path("/media", "david", "DavidRach", "SingleColors", "Myeloid_DHIM")
Subset <- file.path(Folder, "Aug1")

UnstainedBeads <- "Beads\\Unstained"
UnstainedBeads <- list.files(Folder, UnstainedBeads, full.names=TRUE, recursive=TRUE)
Dates1 <- str_extract(UnstainedBeads, "(?<=DHIM/)[^/]+(?=/Beads)")

Fluorophore <- "Alexa Fluor 647"
Beads <- list.files(Folder, Fluorophore, full.names=TRUE, recursive=TRUE)
Beads <- Beads[grep("Beads", Beads)]
Dates2 <- str_extract(Beads, "(?<=DHIM/)[^/]+(?=/CD163)")

if (length(Dates1) != length(Dates2)){stop("Different number of unstained to single color controls")}
```

```{r}
library(flowCore)
library(flowWorkspace)
library(openCyto)
library(Luciernaga)
library(purrr)
library(dplyr)

x <- Dates1[1]
UnstainedList <- UnstainedBeads
FluorophoreList <- Beads
Multiple = FALSE
removestrings=".fcs"

#File_Location <- system.file("extdata", package = "Luciernaga")
#BeadGateCSV <- list.files(File_Location, pattern="GatesBeads.csv", full.names = TRUE)
#GateTemplatePath <- BeadGateCSV
#write.csv(TheGates, "BeadGates.csv", row.names=FALSE)
CSVPath <- getwd()
GateTemplatePath <- file.path(CSVPath, "BeadGates.csv")
```

```{r}
#FileLocation <- system.file("extdata", package = "Luciernaga")
#pattern = "AutofluorescentOverlaps.csv"
#AFOverlap <- list.files(path=FileLocation, pattern=pattern, full.names = TRUE)
AFOverlap <- read.csv("BeadAFOverlap.csv", check.names=FALSE)
#write.csv(AFOverlap, "BeadAFOverlap.csv", row.names=FALSE)
```

```{r}
Data <- Luciernaga_SignatureExternalUnstained(x=Dates1, UnstainedList=UnstainedBeads,
 FluorophoreList=Beads, Multiple=FALSE, GateTemplatePath=GateTemplatePath, AFOverlap=AFOverlap)
```

```{r}
Folder <- "Myeloid"
outpath <- file.path("/home", "david", "Documents", "SingleColors", "data")
outpath <- file.path(outpath, Folder)
filename <- "AF647_CD163_Myeloid"

Dataset <- Data$data
CSVFilename <- paste0(filename, ".csv")
CSVFilename <- file.path(outpath, CSVFilename)
write.csv(Dataset, CSVFilename, row.names=FALSE)

ThePlots <- flatten(Data$plot)
SendPDF <- function(x, outpath, filename, width = 7, height = 9){
    TheName <- paste0(filename, ".pdf")
    StorageLocation <- file.path(outpath, TheName)

    pdf(file = StorageLocation, width = width, height = height)
    print(x)
    dev.off()
}

SendPDF(x=ThePlots, outpath=outpath, filename=filename)
```
