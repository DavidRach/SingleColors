---
title: "ProcessingScript"
format: html
---
```{r}
library(stringr)
library(flowCore)
library(flowWorkspace)
library(openCyto)
library(Luciernaga)
library(purrr)
library(dplyr)
```

```{r}
Folder <- file.path("/media", "david", "DavidRach", "SingleColors", "Myeloid_DHIM")

UnstainedBeads <- "Beads\\Unstained"
UnstainedBeads <- list.files(Folder, UnstainedBeads, full.names=TRUE, recursive=TRUE)
Dates1 <- str_extract(UnstainedBeads, "(?<=DHIM/)[^/]+(?=/Beads)")

Fluorophore <- "PerCP-Cy5.5"
Beads <- list.files(Folder, Fluorophore, full.names=TRUE, recursive=TRUE)
Beads <- Beads[grep("Beads", Beads)]
Dates2 <- str_extract(Beads, "(?<=DHIM/)[^/]+(?=/CD123)")

if (length(Dates1) != length(Dates2)){stop("Different number of unstained to single color controls")}
```

```{r}
CSVPath <- getwd()
GateTemplatePath <- file.path(CSVPath, "BeadGates.csv")

AFOverlap <- read.csv("BeadAFOverlap.csv", check.names=FALSE)
```

```{r}
Data <- Luciernaga_SignatureExternalUnstained(x=Dates1, UnstainedList=UnstainedBeads,
 FluorophoreList=Beads, Multiple=FALSE, GateTemplatePath=GateTemplatePath, AFOverlap=AFOverlap)
```

```{r}
Folder <- "Myeloid"
outpath <- file.path("/home", "david", "Documents", "SingleColors", "data")
outpath <- file.path(outpath, Folder)
filename <- "PerCP-Cy5.5_CD123_Myeloid"

Dataset <- Data$data
CSVFilename <- paste0(filename, ".csv")
CSVFilename <- file.path(outpath, CSVFilename)
write.csv(Dataset, CSVFilename, row.names=FALSE)

ThePlots <- flatten(Data$plot)

SendPDF <- function(x, outpath, filename, width = 7, height = 9){
    TheName <- paste0(filename, ".pdf")
    StorageLocation <- file.path(outpath, TheName)

    pdf(file = StorageLocation, width = width, height = height)
    print(x)
    dev.off()
}

SendPDF(x=ThePlots, outpath=outpath, filename=filename)
```

```{r}
print("Done")
```
